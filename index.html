<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ูุฑูุฒ ูุฑุงูุจุฉ ุงูุงูุชุฎุงุจุงุช โ ุชุณุฌูู ุงูุฏุฎูู ูููุญุงุช ุงูุฃุฏูุงุฑ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{box-sizing:border-box}
    .fade-in{animation:fadeIn .5s ease-in}
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .slide-in{animation:slideIn .3s ease-out}
    @keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
    .pulse-dot{animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">

<!-- ------------------------[ CONFIG ]------------------------- -->
<script>
  // ุถุน ููุง ุฑุงุจุท Web App ููุณูุฑุจุช ุงูุฎุงุต ุจู (ููุณ ุงูุฐู ูุนูู ูุฏูู)
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyLqRd8M5glddJ7esC4vwOkG6PTHCDeISxD0l6iNN7iwvJFTOMrWM7KF5I2LyCEew51/exec";

  // ูููุงุช ูุชุฑุฏุฏุงุช
  const HEARTBEAT_MS = 60000;      // ูุจุถุฉ ุงููุฑุงูุจ ูู 60 ุซุงููุฉ
  const ACTIVITY_REFRESH_MS = 30000;// ุชุญุฏูุซ ููุญุฉ ุงููุดุงุท ูู 30 ุซุงููุฉ

  // ุฃุณูุงุก ุงูุฃุฏูุงุฑ ุจุงูุนุฑุจู
  const ROLE_NAMES = {
    admin: 'ูุฏูุฑ ุงููุธุงู',
    supervisor: 'ูุดุฑู ุนุงู',
    monitor: 'ูุฑุงูุจ ููุฏุงูู',
    operator: 'ูุดุบู ูุฑูุฒ',
    viewer: 'ูุดุงูุฏ'
  };
</script>

<!-- ------------------------[ LOGIN PAGE ]------------------------- -->
<div id="loginPage" class="min-h-screen flex items-center justify-center px-4">
  <div class="max-w-md w-full">
    <div class="text-center mb-8 fade-in">
      <div class="bg-blue-600 text-white p-4 rounded-full w-20 h-20 mx-auto mb-4 flex items-center justify-center">
        <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 20 20">
          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
      <h1 class="text-3xl font-bold text-gray-800 mb-2">ูุฑูุฒ ูุฑุงูุจุฉ ุงูุงูุชุฎุงุจุงุช</h1>
      <p class="text-gray-600">ูุธุงู ุฅุฏุงุฑุฉ ููุฑุงูุจุฉ ุงูุนูููุฉ ุงูุงูุชุฎุงุจูุฉ</p>
    </div>

    <div class="bg-white rounded-xl shadow-lg p-8 fade-in">
      <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">ุชุณุฌูู ุงูุฏุฎูู</h2>

      <form id="loginForm" class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ุงุณู ุงููุณุชุฎุฏู</label>
          <input type="text" id="username" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ุฃุฏุฎู ุงุณู ุงููุณุชุฎุฏู" required>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ูููุฉ ุงููุฑูุฑ / PIN</label>
          <div class="relative">
            <input type="password" id="password" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ุฃู PIN" required>
            <button type="button" id="togglePassword" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              </svg>
            </button>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ููุน ุงููุณุชุฎุฏู</label>
          <select id="userRole" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
            <option value="">ุงุฎุชุฑ ููุน ุงููุณุชุฎุฏู</option>
            <option value="admin">ูุฏูุฑ ุงููุธุงู</option>
            <option value="supervisor">ูุดุฑู ุนุงู</option>
            <option value="monitor">ูุฑุงูุจ ููุฏุงูู</option>
            <option value="operator">ูุดุบู ูุฑูุฒ</option>
            <option value="viewer">ูุดุงูุฏ</option>
          </select>
        </div>

        <div class="flex items-center justify-between">
          <label class="flex items-center">
            <input type="checkbox" id="rememberMe" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <span class="mr-2 text-sm text-gray-600">ุชุฐูุฑูู</span>
          </label>
          <span class="text-sm text-gray-400">ุงูุฅุตุฏุงุฑ: ูุงุฌูุฉ ุนุงูุฉ</span>
        </div>

        <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium">
          ุชุณุฌูู ุงูุฏุฎูู
        </button>
      </form>

      <!-- ุญุณุงุจุงุช ุชุฌุฑูุจูุฉ (ุชูุณุชุฎุฏู ููุท ูู ุชุนุฐุฑ ุงูู API) -->
      <div class="mt-8 p-4 bg-gray-50 rounded-lg">
        <h3 class="text-sm font-medium text-gray-700 mb-3">ุญุณุงุจุงุช ุชุฌุฑูุจูุฉ (ูููุณุฎ ุงูุงุญุชูุงุทู ููุท):</h3>
        <div class="space-y-2 text-xs">
          <div class="flex justify-between"><span class="text-gray-600">ูุฏูุฑ ุงููุธุงู:</span><span class="font-mono">admin / admin123</span></div>
          <div class="flex justify-between"><span class="text-gray-600">ูุดุฑู ุนุงู:</span><span class="font-mono">supervisor / super123</span></div>
          <div class="flex justify-between"><span class="text-gray-600">ูุฑุงูุจ ููุฏุงูู:</span><span class="font-mono">monitor / monitor123</span></div>
          <div class="flex justify-between"><span class="text-gray-600">ูุดุบู ูุฑูุฒ:</span><span class="font-mono">operator / op123</span></div>
          <div class="flex justify-between"><span class="text-gray-600">ูุดุงูุฏ:</span><span class="font-mono">viewer / view123</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ------------------------[ DASHBOARD SHELL ]------------------------- -->
<div id="dashboardPage" class="hidden">
  <!-- Top Bar -->
  <nav class="bg-white shadow-lg border-b-4 border-blue-600">
    <div class="max-w-7xl mx-auto px-4">
      <div class="flex justify-between items-center py-4">
        <div class="flex items-center gap-3">
          <div class="bg-blue-600 text-white p-2 rounded-lg">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <h1 class="text-2xl font-bold text-gray-800">ูุฑูุฒ ูุฑุงูุจุฉ ุงูุงูุชุฎุงุจุงุช</h1>
        </div>
        <div class="flex items-center gap-4">
          <span id="connBadge" class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium flex items-center gap-2">
            <span class="w-2 h-2 bg-green-500 rounded-full pulse-dot"></span>
            ูุชุตู
          </span>
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
              <span id="userInitials" class="text-blue-600 font-medium text-sm"></span>
            </div>
            <div class="text-right">
              <div id="userName" class="text-sm font-medium text-gray-800"></div>
              <div id="userRoleDisplay" class="text-xs text-gray-600"></div>
            </div>
          </div>
          <button id="logoutBtn" class="text-gray-600 hover:text-gray-800 p-2" title="ุชุณุฌูู ุงูุฎุฑูุฌ">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Content -->
  <div class="max-w-7xl mx-auto px-4 py-8">
    <!-- ======== ACTIVITY (ูุดุชุฑู ููุฌููุน ูุง ุนุฏุง viewer) ======== -->
    <div id="activityDashboard" class="hidden mb-8">
      <div class="mb-4">
        <h2 class="text-xl font-bold text-gray-800">ุงููุดุงุท ุงููุญุธู</h2>
        <p class="text-gray-500 text-sm">ุชูุญุฏูุซ ุชููุงุฆููุง ูู 30 ุซุงููุฉ</p>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-xl shadow p-4">
          <p class="text-gray-600 text-sm">ูุดุทูู ุงูุขู</p>
          <p id="activeUsersCount" class="text-3xl font-bold text-green-600">0</p>
        </div>
        <div class="bg-white rounded-xl shadow p-4">
          <p class="text-gray-600 text-sm">ุงุณุชุฑุงุญุฉ</p>
          <p id="breakUsersCount" class="text-3xl font-bold text-yellow-600">0</p>
        </div>
        <div class="bg-white rounded-xl shadow p-4">
          <p class="text-gray-600 text-sm">ูู ูููุฉ</p>
          <p id="taskUsersCount" class="text-3xl font-bold text-blue-600">0</p>
        </div>
        <div class="bg-white rounded-xl shadow p-4">
          <p class="text-gray-600 text-sm">ุบูุฑ ูุชุตู</p>
          <p id="offlineUsersCount" class="text-3xl font-bold text-red-600">0</p>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-4">
        <div class="lg:col-span-2 bg-white rounded-xl shadow p-4">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-bold">ูุงุฆูุฉ ุงููุดุงุท</h3>
            <button id="refreshActivityBtn" class="text-sm px-3 py-1 rounded bg-gray-100 hover:bg-gray-200">ุชุญุฏูุซ</button>
          </div>
          <div id="activityList" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
        </div>

        <div class="bg-white rounded-xl shadow p-4">
          <h3 class="font-bold mb-3">ุฎุฑูุทุฉ ูุจุณุทุฉ</h3>
          <div class="relative bg-gray-100 rounded-lg h-64 overflow-hidden">
            <div id="mapMarkers" class="absolute inset-0"></div>
            <div class="absolute inset-0 flex items-center justify-center text-gray-400 text-sm select-none">ุฎุฑูุทุฉ ุชูุถูุญูุฉ (ุจุฏูู ูุฒูุฏ ุฎุฑุงุฆุท)</div>
          </div>
          <div class="mt-2 text-xs text-gray-500">
            ููุงุญุธุฉ: ููุนุฑุถ ุงูุณุฑูุน ููุท. ุงูุฎุฑุงุฆุท ุงูุฏูููุฉ ูููู ุฅุถุงูุชูุง ูุงุญููุง ุนุจุฑ Leaflet.
          </div>
        </div>
      </div>
    </div>

    <!-- ======== ADMIN ======== -->
    <div id="adminDashboard" class="hidden">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-2">ููุญุฉ ุชุญูู ุงููุฏูุฑ</h2>
        <p class="text-gray-600">ุฅุฏุงุฑุฉ ุดุงููุฉ ูุฌููุน ุฌูุงูุจ ุงููุธุงู</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">ุฅุฌูุงูู ุงููุณุชุฎุฏููู</p>
              <p id="statUsers" class="text-3xl font-bold text-blue-600">0</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-lg">
              <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">ุงููุฑุงูุฒ ุงููุดุทุฉ</p>
              <p id="statCenters" class="text-3xl font-bold text-green-600">0</p>
            </div>
            <div class="bg-green-100 p-3 rounded-lg">
              <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3z"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">ุงูุชูุงุฑูุฑ ุงูููููุฉ</p>
              <p id="statDailyReports" class="text-3xl font-bold text-purple-600">0</p>
            </div>
            <div class="bg-purple-100 p-3 rounded-lg">
              <svg class="w-6 h-6 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1a1 1 0 001 1h6a1 1 0 001-1V3a2 2 0 012 2v6a2 2 0 01-2 2H6a2 2 0 01-2-2V5z"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 text-sm">ุญุงูุฉ ุงููุธุงู</p>
              <p id="statSystem" class="text-lg font-bold text-green-600">-</p>
            </div>
            <div class="bg-green-100 p-3 rounded-lg">
              <div class="w-2 h-2 bg-green-500 rounded-full pulse-dot"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-bold mb-4">ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</h3>
          <div class="space-y-3">
            <button class="w-full bg-blue-100 text-blue-800 py-3 px-4 rounded-lg hover:bg-blue-200 transition-colors text-right">
              ๐ฅ ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ
            </button>
            <button class="w-full bg-green-100 text-green-800 py-3 px-4 rounded-lg hover:bg-green-200 transition-colors text-right">
              ๐ง ุฅุฏุงุฑุฉ ุงูุตูุงุญูุงุช
            </button>
            <button id="btnUsersReport" class="w-full bg-purple-100 text-purple-800 py-3 px-4 rounded-lg hover:bg-purple-200 transition-colors text-right">
              ๐ ุชูุงุฑูุฑ ุงููุณุชุฎุฏููู
            </button>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-bold mb-4">ุฅุนุฏุงุฏุงุช ุงููุธุงู</h3>
          <div class="space-y-3">
            <button class="w-full bg-orange-100 text-orange-800 py-3 px-4 rounded-lg hover:bg-orange-200 transition-colors text-right">
              โ๏ธ ุฅุนุฏุงุฏุงุช ุนุงูุฉ
            </button>
            <button class="w-full bg-red-100 text-red-800 py-3 px-4 rounded-lg hover:bg-red-200 transition-colors text-right">
              ๐ ุฃูุงู ุงููุธุงู
            </button>
            <button id="btnBackup" class="w-full bg-gray-100 text-gray-800 py-3 px-4 rounded-lg hover:bg-gray-200 transition-colors text-right">
              ๐พ ูุณุฎ ุงุญุชูุงุทู
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ======== SUPERVISOR ======== -->
    <div id="supervisorDashboard" class="hidden">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-2">ููุญุฉ ุชุญูู ุงููุดุฑู ุงูุนุงู</h2>
        <p class="text-gray-600">ูุฑุงูุจุฉ ููุชุงุจุนุฉ ุงูุนูููุงุช ุงูุงูุชุฎุงุจูุฉ</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-bold mb-4">ุงููุฑุงูุฒ ุชุญุช ุงูุฅุดุฑุงู</h3>
          <p id="supCenters" class="text-3xl font-bold text-blue-600 mb-2">0</p>
          <p class="text-sm text-gray-600">ูุฑุงูุฒ ูุนูุงูุฉ</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-bold mb-4">ุงูุญูุงุฏุซ ุงููุนููุฉ</h3>
          <p id="supPending" class="text-3xl font-bold text-orange-600 mb-2">0</p>
          <p class="text-sm text-gray-600">ุชุญุชุงุฌ ูุชุงุจุนุฉ</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-bold mb-4">ุงูุชูุงุฑูุฑ ุงููุฑุณูุฉ (ุงูููู)</h3>
          <p id="supReports" class="text-3xl font-bold text-green-600 mb-2">0</p>
          <p class="text-sm text-gray-600">ุนุฏุฏ ุงูุจูุงุบุงุช/ุงูุชูุงุฑูุฑ</p>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-bold mb-4">ุฃุฏูุงุช ุงูุฅุดุฑุงู</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <button class="bg-blue-100 text-blue-800 py-3 px-4 rounded-lg hover:bg-blue-200 transition-colors">๐ ูุฑุงุฌุนุฉ ุงูุชูุงุฑูุฑ</button>
          <button class="bg-green-100 text-green-800 py-3 px-4 rounded-lg hover:bg-green-200 transition-colors">โ ุงุนุชูุงุฏ ุงูุจูุงูุงุช</button>
          <button class="bg-orange-100 text-orange-800 py-3 px-4 rounded-lg hover:bg-orange-200 transition-colors">๐จ ุฅุฏุงุฑุฉ ุงูุชูุจููุงุช</button>
          <button id="btnSupFullReport" class="bg-purple-100 text-purple-800 py-3 px-4 rounded-lg hover:bg-purple-200 transition-colors">๐ ุชูุฑูุฑ ุดุงูู</button>
        </div>
      </div>
    </div>

    <!-- ======== MONITOR ======== -->
    <div id="monitorDashboard" class="hidden">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-2">ููุญุฉ ุชุญูู ุงููุฑุงูุจ ุงูููุฏุงูู</h2>
        <p class="text-gray-600">ุชุณุฌูู ููุชุงุจุนุฉ ุงูุฃุญุฏุงุซ ุงูููุฏุงููุฉ</p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-bold mb-4">ุฅุจูุงุบ ุณุฑูุน</h3>
          <div class="space-y-3">
            <button class="w-full bg-red-100 text-red-800 py-3 px-4 rounded-lg hover:bg-red-200 transition-colors text-right" data-quick="critical">๐จ ุญุงุฏุซ ุนุงุฌู</button>
            <button class="w-full bg-orange-100 text-orange-800 py-3 px-4 rounded-lg hover:bg-orange-200 transition-colors text-right" data-quick="equipment">โ๏ธ ูุดููุฉ ุชูููุฉ</button>
            <button class="w-full bg-yellow-100 text-yellow-800 py-3 px-4 rounded-lg hover:bg-yellow-200 transition-colors text-right" data-quick="crowd">๐ฅ ุงุฒุฏุญุงู</button>
            <button class="w-full bg-blue-100 text-blue-800 py-3 px-4 rounded-lg hover:bg-blue-200 transition-colors text-right" data-quick="note">๐ ููุงุญุธุฉ ุนุงูุฉ</button>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-bold mb-4">ุงูุญุงูุฉ ุงูููุฏุงููุฉ</h3>
          <div class="space-y-3 text-sm">
            <div class="flex justify-between"><span>ุญุงูุฉ ุงูุงุชุตุงู</span><span id="monConn" class="font-medium text-green-600">ูุชุตู</span></div>
            <div class="flex justify-between"><span>ุขุฎุฑ ูุจุถุฉ</span><span id="monBeat" class="text-gray-600">-</span></div>
            <div class="flex justify-between"><span>ุงููููุน ุงูุญุงูู</span><span id="monLoc" class="text-gray-600">-</span></div>
            <div class="flex justify-between"><span>ุงูููุฏ/ุงููุฑูุฒ</span><span id="monCenter" class="text-gray-600">-</span></div>
          </div>
          <div class="mt-4 flex gap-2">
            <button id="btnStartShift" class="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700">ุจุฏุก ุงูููุจุฉ</button>
            <button id="btnEndShift"   class="flex-1 bg-gray-200 text-gray-800 py-2 rounded hover:bg-gray-300">ุฅููุงุก ุงูููุจุฉ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ======== OPERATOR ======== -->
    <div id="operatorDashboard" class="hidden">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-2">ููุญุฉ ุชุญูู ูุดุบู ุงููุฑูุฒ</h2>
        <p class="text-gray-600">ุฅุฏุงุฑุฉ ุนูููุงุช ุงููุฑูุฒ ุงูุงูุชุฎุงุจู</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-bold mb-4">ุญุงูุฉ ุงููุฑูุฒ</h3>
          <div class="space-y-4">
            <div class="flex justify-between items-center"><span>ุญุงูุฉ ุงูุชุดุบูู</span><span id="opRun" class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">ูุดุท</span></div>
            <div class="flex justify-between items-center"><span>ุนุฏุฏ ุงููุงุฎุจูู</span><span id="opVoters" class="font-bold">0</span></div>
            <div class="flex justify-between items-center"><span>ุงูุฃุตูุงุช ุงููุณุฌูุฉ</span><span id="opVotes" class="font-bold text-blue-600">0</span></div>
            <div class="flex justify-between items-center"><span>ูุณุจุฉ ุงููุดุงุฑูุฉ</span><span id="opRate" class="font-bold text-green-600">0%</span></div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-bold mb-4">ุนูููุงุช ุณุฑูุนุฉ</h3>
          <div class="space-y-3">
            <button class="w-full bg-blue-100 text-blue-800 py-3 px-4 rounded-lg hover:bg-blue-200 transition-colors text-right">๐ ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช</button>
            <button class="w-full bg-green-100 text-green-800 py-3 px-4 rounded-lg hover:bg-green-200 transition-colors text-right">๐ ุชุณุฌูู ููุงุญุธุฉ</button>
            <button class="w-full bg-orange-100 text-orange-800 py-3 px-4 rounded-lg hover:bg-orange-200 transition-colors text-right">๐ง ุทูุจ ุฏุนู ุชููู</button>
            <button class="w-full bg-purple-100 text-purple-800 py-3 px-4 rounded-lg hover:bg-purple-200 transition-colors text-right">๐ ุฅุฑุณุงู ุชูุฑูุฑ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ======== VIEWER ======== -->
    <div id="viewerDashboard" class="hidden">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-2">ููุญุฉ ุงููุดุงูุฏุฉ</h2>
        <p class="text-gray-600">ุนุฑุถ ุงูุจูุงูุงุช ูุงูุฅุญุตุงุฆูุงุช</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-bold mb-4">ุฅุฌูุงูู ุงููุฑุงูุฒ</h3>
          <p id="vwCenters" class="text-3xl font-bold text-blue-600">0</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-bold mb-4">ุฅุฌูุงูู ุงููุงุฎุจูู</h3>
          <p id="vwVoters" class="text-3xl font-bold text-green-600">0</p>
        </div>
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-lg font-bold mb-4">ูุณุจุฉ ุงููุดุงุฑูุฉ</h3>
          <p id="vwRate" class="text-3xl font-bold text-purple-600">0%</p>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-bold mb-4">ุงูุฅุญุตุงุฆูุงุช ุงูุนุงูุฉ</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h4 class="font-medium mb-3">ุชูุฒูุน ุงูุญูุงุฏุซ ุญุณุจ ุงูููุน</h4>
            <div class="space-y-2" id="vwTypeDist"></div>
          </div>
          <div>
            <h4 class="font-medium mb-3">ุญุงูุฉ ุงููุฑุงูุฒ</h4>
            <div class="space-y-2" id="vwCenterState"></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ุฑุณุงุฆู ุนุงุฆูุฉ -->
<div id="messageContainer" class="fixed top-4 left-4 z-50"></div>

<!-- ------------------------[ APP LOGIC ]------------------------- -->
<script>
  // ุฌูุณุฉ ุงููุณุชุฎุฏู
  let currentUser = null;
  let heartbeatTimer = null;
  let activityTimer = null;
  let demoMode = false; // ูุนูู ุชููุงุฆูุงู ูู ุชุนุฐุฑ ุงูู API

  // ุญุณุงุจุงุช ุชุฌุฑูุจูุฉ ููุณุฎ ุงุญุชูุงุทู ููุท
  const FALLBACK_USERS = {
    admin:      { password:'admin123',      role:'admin',      name:'ุฃุญูุฏ ุงููุฏูุฑ'     },
    supervisor: { password:'super123',      role:'supervisor', name:'ูุงุทูุฉ ุงููุดุฑูุฉ'   },
    monitor:    { password:'monitor123',    role:'monitor',    name:'ูุญูุฏ ุงููุฑุงูุจ'    },
    operator:   { password:'op123',         role:'operator',   name:'ุณุงุฑุฉ ุงููุดุบูุฉ'    },
    viewer:     { password:'view123',       role:'viewer',     name:'ุนูู ุงููุดุงูุฏ'     },
  };

  // ุนูุงุตุฑ DOM ุณุฑูุนุฉ
  const $ = (id)=>document.getElementById(id);

  // ุฑุณุงุฆู
  function toast(text,type='success'){
    const c=$('messageContainer'); const d=document.createElement('div');
    d.className = (type==='success'?'bg-green-500':'bg-red-500')+' text-white px-6 py-3 rounded-lg shadow-lg mb-2 slide-in';
    d.textContent = text; c.appendChild(d); setTimeout(()=>d.remove(),4500);
  }

  // ุชุจุฏูู ุฅุธูุงุฑ ูููุฉ ุงููุฑูุฑ
  document.addEventListener('DOMContentLoaded',()=>{
    $('togglePassword').addEventListener('click',()=>{
      const p=$('password'); p.type = (p.type==='password'?'text':'password');
    });
    $('loginForm').addEventListener('submit',handleLogin);
    $('logoutBtn').addEventListener('click',handleLogout);
    document.body.addEventListener('click',(e)=>{
      if(e.target?.id==='refreshActivityBtn'){ updateActivity(true); toast('ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงููุดุงุท','success'); }
    });

    // ุงุณุชุนุงุฏุฉ ุฌูุณุฉ
    const saved=localStorage.getItem('currentUser');
    if(saved){ try{ currentUser=JSON.parse(saved); showDashboard(); }catch{} }
  });

  // ุงุชุตุงู API ุนุงู (GET/POST)
  async function api(action, payload={}, method='POST'){
    const url = GAS_URL + '?action=' + encodeURIComponent(action);
    const opts = (method==='GET')
      ? { method:'GET' }
      : { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) };

    try{
      const res = await fetch(url, opts);
      const isJson = (res.headers.get('content-type')||'').includes('application/json');
      const data = isJson ? await res.json() : await res.text();
      if(!res.ok) throw new Error(typeof data==='string'?data:(data?.error||'HTTP '+res.status));
      return data;
    }catch(err){
      console.warn('API error', action, err);
      // ูุถุน ุงููุณุฎ ุงูุงุญุชูุงุทู ุจุฏูู ูุณุฑ ุงููุงุฌูุฉ
      if(!demoMode){ demoMode = true; $('connBadge').classList.remove('bg-green-100','text-green-800'); $('connBadge').classList.add('bg-yellow-100','text-yellow-800'); $('connBadge').innerHTML = '<span class="w-2 h-2 bg-yellow-500 rounded-full pulse-dot"></span> ูุถุน ุงูุงุฎุชุจุงุฑ';
      }
      return {ok:false,error:String(err)};
    }
  }

  // ุชุณุฌูู ุงูุฏุฎูู
  async function handleLogin(e){
    e.preventDefault();
    const username=$('username').value.trim();
    const password=$('password').value.trim();
    const role=$('userRole').value;

    // ูุญุงููุฉ ุนุจุฑ ุงูู API
    let ok=false, name=username;
    if(GAS_URL){
      const resp = await api('login',{username, password, role},'POST');
      if(resp && resp.ok && resp.user){
        ok=true; name=resp.user.full_name||username;
      }
    }
    // fallback ูุญูู
    if(!ok && FALLBACK_USERS[username] && FALLBACK_USERS[username].password===password && FALLBACK_USERS[username].role===role){
      ok=true; name=FALLBACK_USERS[username].name;
    }

    if(!ok){ toast('ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ','error'); return; }

    currentUser = { username, role, name };
    if($('rememberMe').checked){ localStorage.setItem('currentUser', JSON.stringify(currentUser)); }
    toast('ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ','success');
    setTimeout(showDashboard, 500);
  }

  // ุชุณุฌูู ุงูุฎุฑูุฌ
  function handleLogout(){
    localStorage.removeItem('currentUser'); currentUser=null;
    clearInterval(heartbeatTimer); clearInterval(activityTimer);
    $('dashboardPage').classList.add('hidden');
    $('loginPage').classList.remove('hidden');
    $('loginForm').reset();
    toast('ุชู ุชุณุฌูู ุงูุฎุฑูุฌ','success');
  }

  // ุนุฑุถ ุงูููุญุงุช ุญุณุจ ุงูุฏูุฑ + ุจุฏุก ุงูุฎุฏูุงุช ุงููุดุชุฑูุฉ
  function showDashboard(){
    $('loginPage').classList.add('hidden');
    $('dashboardPage').classList.remove('hidden');

    // ูุนูููุงุช ุงููุณุชุฎุฏู
    $('userName').textContent = currentUser.name;
    $('userRoleDisplay').textContent = ROLE_NAMES[currentUser.role] || currentUser.role;
    $('userInitials').textContent = (currentUser.name||'?').charAt(0);

    // ุฅุฎูุงุก ุงููู
    ['adminDashboard','supervisorDashboard','monitorDashboard','operatorDashboard','viewerDashboard'].forEach(id=>{
      $(id).classList.add('hidden');
    });

    // ุฅุธูุงุฑ ุญุณุจ ุงูุฏูุฑ
    const dashId = currentUser.role + 'Dashboard';
    if($(dashId)){ $(dashId).classList.remove('hidden'); $(dashId).classList.add('fade-in'); }

    // ุงููุดุงุท (ูุธูุฑ ููุฌููุน ูุง ุนุฏุง viewer)
    if(currentUser.role!=='viewer'){ $('activityDashboard').classList.remove('hidden'); startActivityAuto(); }
    else { $('activityDashboard').classList.add('hidden'); clearInterval(activityTimer); }

    // ูุจุถุงุช ุงููุฑุงูุจ/ุงููุดุบู ููุท
    if(currentUser.role==='monitor' || currentUser.role==='operator'){ startHeartbeat(); }
    else { clearInterval(heartbeatTimer); }
    // ุชุญููู ุฅุญุตุงุกุงุช ุนุงูุฉ
    loadTopStats();
  }

  // ุฅุญุตุงุกุงุช ุฃุนูู ุงูููุญุงุช
  async function loadTopStats(){
    // ูุญุงููุฉ ูู API
    const resp = await api('stats',{},'GET');
    if(resp && resp.ok){
      $('statUsers').textContent       = resp.users_total ?? 0;
      $('statCenters').textContent     = resp.centers_active ?? 0;
      $('statDailyReports').textContent= resp.reports_today ?? 0;
      $('statSystem').textContent      = (resp.system_ok?'ููุชุงุฒ':'ุชุญูู ูุทููุจ');
      $('supCenters').textContent      = resp.centers_active ?? 0;
      $('supPending').textContent      = resp.pending_incidents ?? 0;
      $('supReports').textContent      = resp.reports_today ?? 0;
      $('vwCenters').textContent       = resp.centers_total ?? 0;
      $('vwVoters').textContent        = resp.voters_total ?? 0;
      $('vwRate').textContent          = (resp.turnout_rate??0)+'%';
      // ุชูุฒูุน ุฃููุงุน ุงูุญูุงุฏุซ (viewer)
      if(resp.type_dist){
        $('vwTypeDist').innerHTML = Object.entries(resp.type_dist).map(([k,v])=>(
          `<div class="flex justify-between"><span>${typeText(k)}</span><span class="font-bold">${v}%</span></div>`
        )).join('');
      }
      if(resp.center_state){
        $('vwCenterState').innerHTML = Object.entries(resp.center_state).map(([k,v])=>(
          `<div class="flex justify-between"><span>${centerStateText(k)}</span><span class="font-bold">${v}</span></div>`
        )).join('');
      }
      return;
    }
    // Fallback ุฃุฑูุงู ุชุฌุฑูุจูุฉ ูุญููุธุฉ
    $('statUsers').textContent=247; $('statCenters').textContent=156; $('statDailyReports').textContent=89; $('statSystem').textContent='ูุถุน ุงูุงุฎุชุจุงุฑ';
    $('supCenters').textContent=45; $('supPending').textContent=12; $('supReports').textContent=38;
    $('vwCenters').textContent=200; $('vwVoters').textContent=2450000; $('vwRate').textContent='68.2%';
    $('vwTypeDist').innerHTML = `
      <div class="flex justify-between"><span>ุชููู</span><span class="font-bold">45%</span></div>
      <div class="flex justify-between"><span>ุฅุฌุฑุงุฆู</span><span class="font-bold">30%</span></div>
      <div class="flex justify-between"><span>ุฃููู</span><span class="font-bold">15%</span></div>
      <div class="flex justify-between"><span>ุฃุฎุฑู</span><span class="font-bold">10%</span></div>`;
    $('vwCenterState').innerHTML = `
      <div class="flex justify-between"><span>ูุดุทุฉ</span><span class="font-bold text-green-600">185</span></div>
      <div class="flex justify-between"><span>ูุชูููุฉ ูุคูุชุงู</span><span class="font-bold text-yellow-600">12</span></div>
      <div class="flex justify-between"><span>ูุบููุฉ</span><span class="font-bold text-red-600">3</span></div>`;
  }

  // ุจุฏุก ูุจุถุงุช ุงููุฑุงูุจ (Check-ins)
  function startHeartbeat(){
    sendHeartbeat(); // ุฃูู ูุฑุฉ ููุฑูุง
    clearInterval(heartbeatTimer);
    heartbeatTimer = setInterval(sendHeartbeat, HEARTBEAT_MS);
  }

  // ุฅุฑุณุงู ูุจุถุฉ + ุชุญุฏูุฏ ูููุน
  async function sendHeartbeat(){
    if(!navigator.geolocation){
      $('monConn')?.classList.remove('text-green-600'); $('monConn')?.classList.add('text-yellow-600');
      $('monConn') && ( $('monConn').textContent='ุจุฏูู ูููุน (ุงููุชุตูุญ)' );
      return;
    }
    navigator.geolocation.getCurrentPosition(async (pos)=>{
      const lat = +pos.coords.latitude.toFixed(6);
      const lng = +pos.coords.longitude.toFixed(6);
      $('monLoc') && ( $('monLoc').textContent = `${lat}, ${lng}` );
      $('monBeat') && ( $('monBeat').textContent = new Date().toLocaleTimeString('ar-IQ') );

      // center_code ุงุฎุชูุงุฑู (ูููู ูุฑุงุกุชู ูู ุฅุนุฏุงุฏุงุช ุงููุณุชุฎุฏู ุนุจุฑ API ูุงุญููุง)
      const center_code = localStorage.getItem('center_code') || '';

      const payload = {
        username: currentUser.username,
        role: currentUser.role,
        center_code,
        lat, lng,
        note: 'heartbeat'
      };
      const resp = await api('heartbeat', payload, 'POST');
      if(resp && resp.ok){
        $('monConn')?.classList.remove('text-yellow-600'); $('monConn')?.classList.add('text-green-600');
        $('monConn') && ( $('monConn').textContent='ูุชุตู' );
        if(resp.center_name){ $('monCenter').textContent = `${center_code||'-'} / ${resp.center_name}`; }
      }else{
        $('monConn')?.classList.remove('text-green-600'); $('monConn')?.classList.add('text-yellow-600');
        $('monConn') && ( $('monConn').textContent='ูุถุน ุงูุงุฎุชุจุงุฑ' );
      }
    },(err)=>{
      $('monConn')?.classList.remove('text-green-600'); $('monConn')?.classList.add('text-red-600');
      $('monConn') && ( $('monConn').textContent='ุฑูุถ ุงููููุน' );
      console.warn('geo error',err);
    },{enableHighAccuracy:true,maximumAge:10000,timeout:8000});
  }

  // ูุดุงุท ุนุงู (ูุงุฆูุฉ + ุฎุฑูุทุฉ + ุฅุญุตุงุกุงุช)
  function startActivityAuto(){
    updateActivity(true);
    clearInterval(activityTimer);
    activityTimer = setInterval(updateActivity, ACTIVITY_REFRESH_MS);
  }

  async function updateActivity(first=false){
    // ูู API: ูุชููุน action=active_users ูุฑุฌูุน [{name, role, status, lat, lng, center_code, last_update, work_start, place_name}]
    const resp = await api('active_users', {}, 'GET');
    let users=[];
    if(resp && resp.ok && Array.isArray(resp.items)){ users = resp.items; }
    else {
      // ุจูุงูุงุช ุชุฌุฑูุจูุฉ ูุง ุชูุณุฑ ุงููุงุฌูุฉ
      users = [
        {id:1,name:'ุฃุญูุฏ ูุญูุฏ', role:'monitor',   status:'active',  lat:33.3152, lng:44.3661, place_name:'ูุฑูุฒ ุงูุดูุฏุงุก', last_update:new Date(),             work_start:'08:00', center_code:'C001'},
        {id:2,name:'ูุงุทูุฉ ุนูู', role:'operator',  status:'active',  lat:33.3200, lng:44.3700, place_name:'ูุฑูุฒ ุงูููุฑ',   last_update:new Date(Date.now()-5*60*1000), work_start:'08:00', center_code:'C002'},
        {id:3,name:'ูุญูุฏ ุญุณู',  role:'monitor',   status:'break',   lat:33.3100, lng:44.3600, place_name:'ูุฑูุฒ ุงูุฃูู',   last_update:new Date(Date.now()-10*60*1000),work_start:'08:00', center_code:'C003'},
        {id:4,name:'ุณุงุฑุฉ ุฃุญูุฏ', role:'supervisor',status:'task',    lat:33.3250, lng:44.3750, place_name:'ูุฑูุฒ ุงููุญุฏุฉ', last_update:new Date(Date.now()-2*60*1000), work_start:'07:30', center_code:'C004'},
        {id:5,name:'ุนูู ุญุณูู',  role:'operator',  status:'offline', lat:33.3180, lng:44.3650, place_name:'ูุฑูุฒ ุงูุณูุงู', last_update:new Date(Date.now()-45*60*1000),work_start:'08:00', center_code:'C005'},
        {id:6,name:'ุฒููุจ ูุญููุฏ',role:'monitor',   status:'active',  lat:33.3300, lng:44.3800, place_name:'ูุฑูุฒ ุงูุชูุฏู', last_update:new Date(Date.now()-1*60*1000), work_start:'08:00', center_code:'C006'},
      ];
    }
    renderActivity(users);
    if(first) toast(demoMode?'ุชู ุชูุนูู ูุถุน ุงูุงุฎุชุจุงุฑ (ุจุฏูู ูุณุฑ ุงููุงุฌูุฉ)':'ุชู ุงูุงุชุตุงู ุจุงููุตุฏุฑ','success');
  }

  function renderActivity(users){
    const statusOrder = {active:0, task:1, break:2, offline:3};
    users.sort((a,b)=> (statusOrder[a.status]??9)-(statusOrder[b.status]??9));

    const active = users.filter(u=>u.status==='active').length;
    const brk    = users.filter(u=>u.status==='break').length;
    const task   = users.filter(u=>u.status==='task').length;
    const off    = users.filter(u=>u.status==='offline').length;

    $('activeUsersCount').textContent = active;
    $('breakUsersCount').textContent  = brk;
    $('taskUsersCount').textContent   = task;
    $('offlineUsersCount').textContent= off;

    $('activityList').innerHTML = users.map(u=>{
      const statusColors = {active:'bg-green-100 text-green-800', break:'bg-yellow-100 text-yellow-800', offline:'bg-red-100 text-red-800', task:'bg-blue-100 text-blue-800'};
      const statusTexts  = {active:'ูุดุท', break:'ุงุณุชุฑุงุญุฉ', offline:'ุบูุฑ ูุชุตู', task:'ูู ูููุฉ'};
      const roleTexts    = {monitor:'ูุฑุงูุจ', operator:'ูุดุบู', supervisor:'ูุดุฑู', admin:'ูุฏูุฑ'};
      const last = new Date(u.last_update||Date.now());
      const diffMin = Math.max(0, Math.floor((Date.now() - last)/60000));
      const timeText = diffMin<1?'ุงูุขู':`ููุฐ ${diffMin} ุฏูููุฉ`;

      return `
      <div class="bg-white border rounded-lg p-3 hover:shadow-md transition-shadow">
        <div class="flex justify-between items-start mb-2">
          <div>
            <h5 class="font-medium text-gray-800">${u.name||'-'}</h5>
            <p class="text-xs text-gray-500">${roleTexts[u.role]||u.role} - ${u.center_code||'-'}</p>
          </div>
          <span class="px-2 py-1 text-xs rounded-full ${statusColors[u.status]||'bg-gray-100 text-gray-800'}">${statusTexts[u.status]||u.status}</span>
        </div>
        <div class="flex justify-between items-center text-xs text-gray-600">
          <span>๐ ${u.place_name||'ุบูุฑ ูุนุฑูู'}</span>
          <span>๐ ${timeText}</span>
        </div>
        <div class="mt-2 text-xs text-gray-500">ุจุฏุงูุฉ ุงูุฏูุงู: ${u.work_start||'-'}</div>
      </div>`;
    }).join('');

    // ุฎุฑูุทุฉ ูุจุณุทุฉ (ุชุญููู lat/lng ุฅูู ุฅุญุฏุงุซูุงุช ุฏุงุฎู ุตูุฏูู)
    const map = $('mapMarkers'); map.innerHTML='';
    users.forEach(u=>{
      const x = ((Number(u.lng)-44.35)*1000)+50;
      const y = ((33.33-Number(u.lat))*1000)+50;
      const clamp=(v,min,max)=>Math.max(min,Math.min(v,max));
      const color = {active:'bg-green-500', break:'bg-yellow-500', offline:'bg-red-500', task:'bg-blue-500'}[u.status] || 'bg-gray-500';
      const div = document.createElement('div');
      div.className = `absolute w-4 h-4 ${color} rounded-full border-2 border-white shadow-lg transform -translate-x-1/2 -translate-y-1/2 cursor-pointer hover:scale-125 transition-transform`;
      div.style.left = clamp(x,10,240)+'px';
      div.style.top  = clamp(y,10,240)+'px';
      div.title = `${u.name||''} โ ${u.place_name||''}`;
      map.appendChild(div);
    });
  }

  // ูุตูุต ูุณุงุนุฏุฉ
  function typeText(t){ return ({equipment:'ุชููู', security:'ุฃููู', procedural:'ุฅุฌุฑุงุฆู', crowd:'ุงุฒุฏุญุงู', other:'ุฃุฎุฑู'})[t]||t; }
  function centerStateText(s){ return ({active:'ูุดุทุฉ', paused:'ูุชูููุฉ ูุคูุชุงู', closed:'ูุบููุฉ'})[s]||s; }

  // ุฃุฒุฑุงุฑ ุงููุฑุงูุจ ุงูุณุฑูุนุฉ (ุฑูุน ุญุงุฏุซ ูุจุณุท)
  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('[data-quick]');
    if(!btn) return;
    const kind = btn.getAttribute('data-quick');
    const mapSeverity = {critical:'critical', equipment:'high', crowd:'medium', note:'low'};
    const mapType     = {critical:'security', equipment:'equipment', crowd:'crowd', note:'other'};
    const title       = {critical:'ุญุงุฏุซ ุนุงุฌู', equipment:'ูุดููุฉ ุชูููุฉ', crowd:'ุงุฒุฏุญุงู', note:'ููุงุญุธุฉ ุนุงูุฉ'}[kind];

    let lat=null,lng=null;
    try{
      await new Promise((res,rej)=>{
        if(!navigator.geolocation) return res();
        navigator.geolocation.getCurrentPosition(p=>{lat=+p.coords.latitude.toFixed(6); lng=+p.coords.longitude.toFixed(6); res();},()=>res(),{timeout:4000});
      });
    }catch{}

    const payload = {
      title, severity:mapSeverity[kind], type:mapType[kind],
      center_code: localStorage.getItem('center_code')||'',
      center_name: '', description: title, reported_by: currentUser?.name||'',
      lat, lng
    };
    const resp = await api('create_incident', payload, 'POST');
    if(resp && resp.ok){ toast('ุชู ุฅุฑุณุงู ุงูุจูุงุบ ุจูุฌุงุญ #'+resp.id,'success'); }
    else { toast('ุชู ุญูุธ ุงูุจูุงุบ ูุญูููุง (ูุถุน ุงูุงุฎุชุจุงุฑ)','success'); }
  });

  // ุจุฏุก/ุฅููุงุก ุงูููุจุฉ (ูุญูุธ center_code ูุญูููุง ุฅู ูุฒู)
  $('btnStartShift')?.addEventListener('click', async ()=>{
    const centerCode = prompt('ุฃุฏุฎู ุฑูุฒ ุงููุฑูุฒ (ุงุฎุชูุงุฑู):','');
    if(centerCode) localStorage.setItem('center_code', centerCode);
    toast('ุชู ุจุฏุก ุงูููุจุฉ','success'); startHeartbeat();
  });
  $('btnEndShift')?.addEventListener('click', ()=>{
    localStorage.removeItem('center_code'); clearInterval(heartbeatTimer);
    $('monCenter') && ( $('monCenter').textContent='-' );
    toast('ุชู ุฅููุงุก ุงูููุจุฉ','success');
  });

  // ุฃุฒุฑุงุฑ ุฅุฏุงุฑูุฉ ุชุฌุฑูุจูุฉ
  $('btnBackup')?.addEventListener('click', async ()=>{
    const r = await api('backup', {}, 'POST');
    toast(r?.ok?'ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ':'ุชุนุฐุฑ ุชูููุฐ ุงููุณุฎ โ ูุถุน ุงูุงุฎุชุจุงุฑ', r?.ok?'success':'error');
  });
  $('btnUsersReport')?.addEventListener('click', async ()=>{
    const r = await api('users_report', {}, 'GET');
    toast(r?.ok?'ุชู ุชูููุฏ ุชูุฑูุฑ ุงููุณุชุฎุฏููู':'ุชุนุฐุฑ ุงูุชูููุฏ โ ูุถุน ุงูุงุฎุชุจุงุฑ', r?.ok?'success':'error');
  });
  $('btnSupFullReport')?.addEventListener('click', async ()=>{
    const r = await api('full_report', {}, 'GET');
    toast(r?.ok?'ุชู ุฅูุดุงุก ุงูุชูุฑูุฑ ุงูุดุงูู':'ุชุนุฐุฑ ุงูุฅูุดุงุก โ ูุถุน ุงูุงุฎุชุจุงุฑ', r?.ok?'success':'error');
  });

</script>

</body>
</html>
